<<<<<<< HEAD
# Traefik IngressRoute é…ç½®ç¯„ä¾‹
# è¤‡è£½ç‚º traefik-ingress.yaml ä¸¦æ›¿æ›åŸŸå

=======
# Traefik IngressRoute ç”Ÿç”¢é…ç½®
# ðŸ”„ ä½¿ç”¨ä½”ä½ç¬¦ï¼Œé€éŽæ‰‹å‹•æ›¿æ›é€²è¡ŒåŸŸåæ›¿æ›
# âœ… æ­¤æª”æ¡ˆå¯å®‰å…¨æŽ¨é€åˆ° Git Repository
#
# éƒ¨ç½²æ–¹å¼ (æ‰‹å‹•æ›¿æ›):
# sed 's/APP_DOMAIN_PLACEHOLDER/app.system2.work/g; s/N8N_DOMAIN_PLACEHOLDER/n8n.system2.work/g' traefik-ingress.yaml | kubectl apply -f -
#
# å‰ç½®æ¢ä»¶:
# 1. ç¢ºä¿ç›®æ¨™æœå‹™å·²éƒ¨ç½²ä¸¦é‹è¡Œ
# 2. æº–å‚™å¥½å¯¦éš›çš„åŸŸå

---
# ðŸŒ n8n æœå‹™è·¯ç”±
>>>>>>> 5865e04bb291b690c4a7b3cd6be675e2b6f75527
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: n8n-ingress
  namespace: fullstack-app
<<<<<<< HEAD
=======
  labels:
    app: n8n
    component: ingress
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
>>>>>>> 5865e04bb291b690c4a7b3cd6be675e2b6f75527
spec:
  entryPoints:
    - web
    - websecure
  routes:
<<<<<<< HEAD
  - match: Host(`n8n.system2.work`)
=======
  - match: Host(`N8N_DOMAIN_PLACEHOLDER`)  # ðŸ”„ å°‡è¢«æ›¿æ›ç‚ºå¯¦éš›åŸŸå
>>>>>>> 5865e04bb291b690c4a7b3cd6be675e2b6f75527
    kind: Rule
    services:
    - name: n8n-service
      port: 80
    middlewares:
    - name: n8n-headers
<<<<<<< HEAD

---
=======
    - name: security-headers

---
# ðŸš€ çµ±ä¸€æ‡‰ç”¨å…¥å£è·¯ç”± (ä¸»è¦ App åŸŸå)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: app-ingress
  namespace: fullstack-app
  labels:
    app: main-app
    component: ingress
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
spec:
  entryPoints:
    - web
    - websecure
  routes:
  
  # ðŸ¤– Gemma AI API è·¯ç”± (é«˜å„ªå…ˆç´š)
  - match: Host(`APP_DOMAIN_PLACEHOLDER`) && PathPrefix(`/gemma/api`)
    kind: Rule
    priority: 100
    services:
    - name: gemma-backend-service
      port: 80
    middlewares:
    - name: api-headers
    - name: api-cors
    - name: security-headers
    - name: api-rate-limit
  
  # ðŸ“ˆ æœªä¾† Stock API è·¯ç”± (é«˜å„ªå…ˆç´š)
  - match: Host(`APP_DOMAIN_PLACEHOLDER`) && PathPrefix(`/stock/api`)
    kind: Rule
    priority: 100
    services:
    - name: stock-backend-service
      port: 80
    middlewares:
    - name: api-headers
    - name: api-cors
    - name: security-headers
    - name: api-rate-limit
  
  # ðŸ‘¤ æœªä¾† User API è·¯ç”± (é«˜å„ªå…ˆç´š)
  - match: Host(`APP_DOMAIN_PLACEHOLDER`) && PathPrefix(`/user/api`)
    kind: Rule
    priority: 100
    services:
    - name: user-backend-service
      port: 80
    middlewares:
    - name: api-headers
    - name: api-cors
    - name: security-headers
    - name: api-rate-limit
  
  # ðŸŽ¨ å‰ç«¯æ‡‰ç”¨è·¯ç”± (æœ€ä½Žå„ªå…ˆç´šï¼ŒæŽ¥æ”¶æ‰€æœ‰å‰©é¤˜è«‹æ±‚)
  - match: Host(`APP_DOMAIN_PLACEHOLDER`)
    kind: Rule
    priority: 10
    services:
    - name: frontend-service
      port: 80
    middlewares:
    - name: frontend-headers
    - name: security-headers

---
# ðŸ”’ n8n å°ˆç”¨ä¸­é–“ä»¶
>>>>>>> 5865e04bb291b690c4a7b3cd6be675e2b6f75527
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: n8n-headers
  namespace: fullstack-app
<<<<<<< HEAD
spec:
  headers:
    customResponseHeaders:
      Cache-Control: "no-cache"
      Connection: "keep-alive"
      Access-Control-Allow-Origin: "*"
=======
  labels:
    app: n8n
    component: middleware
spec:
  headers:
    customResponseHeaders:
      Cache-Control: "no-cache, no-store, must-revalidate"
      Pragma: "no-cache"
      Connection: "keep-alive"
    customRequestHeaders:
      X-Forwarded-Proto: "https"
      X-Forwarded-Port: "443"

---
# ðŸ”§ API æœå‹™é€šç”¨ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-headers
  namespace: fullstack-app
  labels:
    component: middleware
    type: api
spec:
  headers:
    customResponseHeaders:
      X-API-Version: "v1"
      Cache-Control: "no-cache, no-store, must-revalidate"
    customRequestHeaders:
      X-Forwarded-Proto: "https"
      X-Forwarded-Port: "443"
      X-Real-IP: ""

---
# ðŸŒ API CORS ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-cors
  namespace: fullstack-app
  labels:
    component: middleware
    type: cors
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
      - HEAD
    accessControlAllowHeaders:
      - "*"
    accessControlAllowOriginList:
      - "https://APP_DOMAIN_PLACEHOLDER"  # ðŸ”„ å°‡è¢«æ›¿æ›
      - "https://N8N_DOMAIN_PLACEHOLDER"  # ðŸ”„ å°‡è¢«æ›¿æ›
    accessControlAllowCredentials: true
    accessControlMaxAge: 86400
    addVaryHeader: true

---
# ðŸŽ¨ å‰ç«¯æ‡‰ç”¨ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: frontend-headers
  namespace: fullstack-app
  labels:
    component: middleware
    type: frontend
spec:
  headers:
    customResponseHeaders:
      Cache-Control: "public, max-age=31536000, immutable"
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "SAMEORIGIN"
    customRequestHeaders:
      X-Forwarded-Proto: "https"

---
# ðŸ›¡ï¸ å®‰å…¨æ€§ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: fullstack-app
  labels:
    component: middleware
    type: security
spec:
  headers:
    customResponseHeaders:
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "DENY"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"
      Permissions-Policy: "camera=(), microphone=(), geolocation=(), payment=()"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
    contentTypeNosniff: true
    browserXssFilter: true
    forceSTSHeader: true
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000

---
# â†©ï¸ HTTP åˆ° HTTPS é‡å®šå‘ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: https-redirect
  namespace: fullstack-app
  labels:
    component: middleware
    type: redirect
spec:
  redirectScheme:
    scheme: https
    permanent: true
    port: "443"

---
# ðŸ“Š è«‹æ±‚é™æµä¸­é–“ä»¶ (é˜²æ­¢ API æ¿«ç”¨)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-rate-limit
  namespace: fullstack-app
  labels:
    component: middleware
    type: rate-limit
spec:
  rateLimit:
    average: 100    # å¹³å‡æ¯ç§’ 100 å€‹è«‹æ±‚
    burst: 200      # çªç™¼æœ€å¤š 200 å€‹è«‹æ±‚
    period: 1m      # çµ±è¨ˆé€±æœŸ 1 åˆ†é˜

---
# ðŸ”„ é‡è©¦ä¸­é–“ä»¶ (æé«˜ API å¯é æ€§)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-retry
  namespace: fullstack-app
  labels:
    component: middleware
    type: retry
spec:
  retry:
    attempts: 3
    initialInterval: 100ms
>>>>>>> 5865e04bb291b690c4a7b3cd6be675e2b6f75527
