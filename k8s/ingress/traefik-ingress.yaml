# Traefik IngressRoute ç”Ÿç”¢é…ç½®
# ğŸ”„ ä½¿ç”¨ä½”ä½ç¬¦ï¼Œé€éæ‰‹å‹•æ›¿æ›é€²è¡ŒåŸŸåæ›¿æ›
# âœ… æ­¤æª”æ¡ˆå¯å®‰å…¨æ¨é€åˆ° Git Repository
#
# éƒ¨ç½²æ–¹å¼ (æ‰‹å‹•æ›¿æ›):
# cd k8s/ingress/
# sed 's/APP_DOMAIN_PLACEHOLDER/app.system2.work/g; s/N8N_DOMAIN_PLACEHOLDER/n8n.system2.work/g' traefik-ingress.yaml | kubectl apply -f -
#
# å‰ç½®æ¢ä»¶:
# 1. ç¢ºä¿ç›®æ¨™æœå‹™å·²éƒ¨ç½²ä¸¦é‹è¡Œ (n8n-service, gemma-backend-service)
# 2. æº–å‚™å¥½å¯¦éš›çš„åŸŸå

---
# ğŸŒ n8n æœå‹™è·¯ç”±
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: n8n-ingress
  namespace: fullstack-app
  labels:
    app: n8n
    component: ingress
spec:
  entryPoints:
    - web
    - websecure
  routes:
  - match: Host(`N8N_DOMAIN_PLACEHOLDER`)  # ğŸ”„ å°‡è¢«æ›¿æ›ç‚ºå¯¦éš›åŸŸå
    kind: Rule
    services:
    - name: n8n-service
      port: 80
    middlewares:
    - name: n8n-headers
    - name: security-headers

---
# ğŸš€ çµ±ä¸€æ‡‰ç”¨å…¥å£è·¯ç”± (ä¸»è¦ App åŸŸå)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: app-ingress
  namespace: fullstack-app
  labels:
    app: main-app
    component: ingress
spec:
  entryPoints:
    - web
    - websecure
  routes:
  
  # ğŸ¤– Gemma AI API è·¯ç”± (é«˜å„ªå…ˆç´š)
  - match: Host(`APP_DOMAIN_PLACEHOLDER`) && PathPrefix(`/gemma/api`)
    kind: Rule
    priority: 100
    services:
    - name: gemma-backend-service
      port: 80
    middlewares:
    - name: gemma-stripprefix
    - name: api-headers
    - name: api-cors
    - name: security-headers
    - name: api-rate-limit
  
  # ğŸ”® æœªä¾†æ“´å±•ï¼šå…¶ä»– API è·¯ç”±å¯ä»¥åœ¨é€™è£¡æ·»åŠ 
  # - match: Host(`APP_DOMAIN_PLACEHOLDER`) && PathPrefix(`/stock/api`)
  #   kind: Rule
  #   priority: 100
  #   services:
  #   - name: stock-backend-service
  #     port: 80

---
# ğŸ”§ Gemma API è·¯å¾‘å‰ç¶´ç§»é™¤ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: gemma-stripprefix
  namespace: fullstack-app
spec:
  stripPrefix:
    prefixes:
      - "/gemma/api"  # åªç§»é™¤ /gemma å‰ç¶´ï¼Œä¿ç•™ /api
    forceSlash: false

---
# ğŸ”’ n8n å°ˆç”¨ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: n8n-headers
  namespace: fullstack-app
spec:
  headers:
    customResponseHeaders:
      Cache-Control: "no-cache, no-store, must-revalidate"
      Pragma: "no-cache"
      Connection: "keep-alive"
    customRequestHeaders:
      X-Forwarded-Proto: "https"
      X-Forwarded-Port: "443"

---
# ğŸ”§ API æœå‹™é€šç”¨ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-headers
  namespace: fullstack-app
spec:
  headers:
    customResponseHeaders:
      X-API-Version: "v1"
      Cache-Control: "no-cache, no-store, must-revalidate"
    customRequestHeaders:
      X-Forwarded-Proto: "https"
      X-Forwarded-Port: "443"

---
# ğŸŒ API CORS ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-cors
  namespace: fullstack-app
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
      - HEAD
    accessControlAllowHeaders:
      - "*"
    accessControlAllowOriginList:
      - "https://APP_DOMAIN_PLACEHOLDER"  # ğŸ”„ å°‡è¢«æ›¿æ›
      - "https://N8N_DOMAIN_PLACEHOLDER"  # ğŸ”„ å°‡è¢«æ›¿æ›
    accessControlAllowCredentials: true
    accessControlMaxAge: 86400
    addVaryHeader: true

---
# ğŸ¨ å‰ç«¯æ‡‰ç”¨ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: frontend-headers
  namespace: fullstack-app
spec:
  headers:
    customResponseHeaders:
      Cache-Control: "public, max-age=300"  # 5åˆ†é˜ç·©å­˜ï¼Œé©åˆ API é¦–é 
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "SAMEORIGIN"
    customRequestHeaders:
      X-Forwarded-Proto: "https"

---
# ğŸ›¡ï¸ å®‰å…¨æ€§ä¸­é–“ä»¶
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: fullstack-app
spec:
  headers:
    customResponseHeaders:
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "DENY"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"
      Permissions-Policy: "camera=(), microphone=(), geolocation=(), payment=()"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
    contentTypeNosniff: true
    browserXssFilter: true
    forceSTSHeader: true
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000

---
# ğŸ“Š è«‹æ±‚é™æµä¸­é–“ä»¶ (é˜²æ­¢ API æ¿«ç”¨)
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-rate-limit
  namespace: fullstack-app
spec:
  rateLimit:
    average: 100    # å¹³å‡æ¯ç§’ 100 å€‹è«‹æ±‚
    burst: 200      # çªç™¼æœ€å¤š 200 å€‹è«‹æ±‚
    period: 1m      # çµ±è¨ˆé€±æœŸ 1 åˆ†é˜
